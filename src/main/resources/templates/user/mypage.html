<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/base :: layout(~{::title}, ~{::main})}">
<head>
    <title>마이페이지 - Board Hole</title>
</head>

<main>
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 text-gradient">마이페이지</h1>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-modern btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="me-2">
                    <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
                    <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/>
                </svg>
                프로필 수정
            </button>
            <button type="button" class="btn btn-modern btn-outline-warning" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="me-2">
                    <path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/>
                </svg>
                비밀번호 변경
            </button>
        </div>
    </div>

    <div class="row g-4">
        <!-- 프로필 정보 -->
        <div class="col-lg-4">
            <div class="card card-modern">
                <div class="card-body text-center">
                    <!-- 사용자 아바타 -->
                    <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" 
                         style="width: 120px; height: 120px;">
                        <svg width="48" height="48" fill="currentColor" viewBox="0 0 16 16" class="text-primary">
                            <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/>
                            <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/>
                        </svg>
                    </div>
                    
                    <h4 class="card-title mb-2" th:text="${user.name}">사용자명</h4>
                    <p class="text-muted mb-3" th:text="${user.email}">email@example.com</p>
                    
                    <!-- 활동 통계 -->
                    <div class="bg-light rounded p-3 mb-3">
                        <div class="row g-2">
                            <div class="col-6">
                                <div class="text-center">
                                    <div class="fw-semibold text-primary fs-5" th:text="${user.boardCount ?: 0}">0</div>
                                    <small class="text-muted">내 게시글</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center">
                                    <div class="fw-semibold text-success fs-5" th:text="${user.commentCount ?: 0}">0</div>
                                    <small class="text-muted">내 댓글</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-muted small">
                        <div class="d-flex justify-content-between mb-2">
                            <span>가입일:</span>
                            <span th:text="${#temporals.format(user.createdAt, 'yyyy-MM-dd')}">2024-01-01</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>최근 활동:</span>
                            <span th:text="${user.lastLoginAt != null ? #temporals.format(user.lastLoginAt, 'yyyy-MM-dd HH:mm') : '정보 없음'}">정보 없음</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 빠른 액션 -->
            <div class="card card-modern mt-4">
                <div class="card-header bg-transparent border-bottom">
                    <h6 class="card-title mb-0">빠른 액션</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="/boards/write" class="btn btn-modern btn-outline-primary">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="me-2">
                                <path d="M14.5 3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h13zm-13-1A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h13a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 1h-13z"/>
                            </svg>
                            새 글 작성
                        </a>
                        <a href="/boards" class="btn btn-modern btn-outline-success">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="me-2">
                                <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
                            </svg>
                            게시판 보기
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 활동 내역 -->
        <div class="col-lg-8">
            <!-- 내 최근 게시글 -->
            <div class="card card-modern mb-4">
                <div class="card-header bg-transparent border-bottom">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16" class="me-2">
                                <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
                            </svg>
                            내 최근 게시글
                        </h5>
                        <a href="/boards?author=me" class="btn btn-sm btn-modern btn-outline-primary">더보기</a>
                    </div>
                </div>
                <div class="card-body">
                    <div th:if="${user.recentBoards != null and not user.recentBoards.empty}">
                        <div class="d-flex align-items-start border-bottom pb-3 mb-3" th:each="board : ${user.recentBoards}">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">
                                    <a th:href="@{/boards/{id}(id=${board.id})}" 
                                       class="text-decoration-none" th:text="${board.title}">게시글 제목</a>
                                </h6>
                                <div class="text-muted small d-flex justify-content-between">
                                    <span>
                                        <span th:text="${#temporals.format(board.createdAt, 'yyyy-MM-dd HH:mm')}">작성일</span>
                                        <span class="mx-2">·</span>
                                        조회 <span th:text="${board.viewCount}">0</span>
                                    </span>
                                    <div class="d-flex gap-2">
                                        <a th:href="@{/boards/{id}/edit(id=${board.id})}" 
                                           class="text-decoration-none small">수정</a>
                                        <button type="button" class="btn-link text-danger small p-0 border-0 bg-transparent"
                                                onclick="deleteBoard([[${board.id}]])">삭제</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div th:if="${user.recentBoards == null or user.recentBoards.empty}" class="text-center text-muted py-4">
                        <svg width="48" height="48" fill="currentColor" viewBox="0 0 16 16" class="mb-3">
                            <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
                        </svg>
                        <p>작성한 게시글이 없습니다.</p>
                        <a href="/boards/write" class="btn btn-modern btn-primary">첫 번째 글 작성하기</a>
                    </div>
                </div>
            </div>
            
            <!-- 내 최근 댓글 -->
            <div class="card card-modern">
                <div class="card-header bg-transparent border-bottom">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16" class="me-2">
                                <path d="M2.678 11.894a1 1 0 0 1 .287.801 10.97 10.97 0 0 1-.398 2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8.06 8.06 0 0 0 8 14c3.996 0 7-2.807 7-6 0-3.192-3.004-6-7-6S1 4.808 1 8c0 1.468.617 2.83 1.678 3.894zm-.493 3.905a21.682 21.682 0 0 1-.713.129c-.2.032-.352-.176-.273-.362a9.68 9.68 0 0 0 .244-.637l.003-.01c.248-.72.45-1.548.524-2.319C.743 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7-3.582 7-8 7a9.06 9.06 0 0 1-2.347-.306c-.52.263-1.639.742-3.468 1.105z"/>
                            </svg>
                            내 최근 댓글
                        </h5>
                        <a href="/comments?author=me" class="btn btn-sm btn-modern btn-outline-primary">더보기</a>
                    </div>
                </div>
                <div class="card-body">
                    <div th:if="${user.recentComments != null and not user.recentComments.empty}">
                        <div class="d-flex align-items-start border-bottom pb-3 mb-3" th:each="comment : ${user.recentComments}">
                            <div class="flex-grow-1">
                                <div class="text-truncate mb-2" th:text="${comment.content}">댓글 내용</div>
                                <div class="text-muted small d-flex justify-content-between">
                                    <span>
                                        <a th:href="@{/boards/{id}(id=${comment.boardId})}" 
                                           class="text-decoration-none me-2" th:text="${comment.boardTitle}">게시글 제목</a>
                                        <span th:text="${#temporals.format(comment.createdAt, 'yyyy-MM-dd HH:mm')}">작성일</span>
                                    </span>
                                    <button type="button" class="btn-link text-danger small p-0 border-0 bg-transparent"
                                            onclick="deleteComment([[${comment.id}]])">삭제</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div th:if="${user.recentComments == null or user.recentComments.empty}" class="text-center text-muted py-4">
                        <svg width="48" height="48" fill="currentColor" viewBox="0 0 16 16" class="mb-3">
                            <path d="M2.678 11.894a1 1 0 0 1 .287.801 10.97 10.97 0 0 1-.398 2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8.06 8.06 0 0 0 8 14c3.996 0 7-2.807 7-6 0-3.192-3.004-6-7-6S1 4.808 1 8c0 1.468.617 2.83 1.678 3.894zm-.493 3.905a21.682 21.682 0 0 1-.713.129c-.2.032-.352-.176-.273-.362a9.68 9.68 0 0 0 .244-.637l.003-.01c.248-.72.45-1.548.524-2.319C.743 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7-3.582 7-8 7a9.06 9.06 0 0 1-2.347-.306c-.52.263-1.639.742-3.468 1.105z"/>
                        </svg>
                        <p>작성한 댓글이 없습니다.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 프로필 수정 모달 -->
    <div class="modal fade" id="editProfileModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">프로필 수정</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form th:action="@{/api/users/profile}" method="post" id="profileForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="profileName" class="form-label">이름</label>
                            <input type="text" class="form-control form-control-modern" 
                                   id="profileName" name="name" th:value="${user.name}" required>
                        </div>
                        <div class="mb-3">
                            <label for="profileEmail" class="form-label">이메일</label>
                            <input type="email" class="form-control form-control-modern" 
                                   id="profileEmail" name="email" th:value="${user.email}" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-modern btn-outline-secondary" data-bs-dismiss="modal">취소</button>
                        <button type="submit" class="btn btn-modern btn-primary">저장</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 비밀번호 변경 모달 -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">비밀번호 변경</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form th:action="@{/api/users/change-password}" method="post" id="passwordForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="currentPassword" class="form-label">현재 비밀번호</label>
                            <input type="password" class="form-control form-control-modern" 
                                   id="currentPassword" name="currentPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">새 비밀번호</label>
                            <input type="password" class="form-control form-control-modern" 
                                   id="newPassword" name="newPassword" required minlength="8">
                        </div>
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">새 비밀번호 확인</label>
                            <input type="password" class="form-control form-control-modern" 
                                   id="confirmPassword" name="confirmPassword" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-modern btn-outline-secondary" data-bs-dismiss="modal">취소</button>
                        <button type="submit" class="btn btn-modern btn-warning">변경</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</th:block>

<th:block layout:fragment="extra-js">
    <script>
        // 게시글 삭제
        function deleteBoard(boardId) {
            if (confirm('정말로 이 게시글을 삭제하시겠습니까?')) {
                fetch(`/api/boards/${boardId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('삭제에 실패했습니다.');
                    }
                })
                .catch(error => {
                    alert('오류가 발생했습니다.');
                });
            }
        }
        
        // 댓글 삭제
        function deleteComment(commentId) {
            if (confirm('정말로 이 댓글을 삭제하시겠습니까?')) {
                fetch(`/api/comments/${commentId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('삭제에 실패했습니다.');
                    }
                })
                .catch(error => {
                    alert('오류가 발생했습니다.');
                });
            }
        }
        
        // 비밀번호 확인 검증
        document.getElementById('passwordForm').addEventListener('submit', function(e) {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                e.preventDefault();
                alert('새 비밀번호와 확인 비밀번호가 일치하지 않습니다.');
                return;
            }
        });
    </script>
 </main>
</html>
