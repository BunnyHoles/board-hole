<!DOCTYPE html>
<html lang="ko"
      th:replace="~{fragments/base :: layout(title='게시판', content=~{::section}, contextMenu=~{::contextMenu})}"
      xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <title>게시판</title>
</head>
<body>
<!-- 컨텍스트 메뉴 Fragment (헤더에 주입될 부분) -->
<th:block th:fragment="contextMenu">
    <li>
        <button id="context-menu-anchor" popovertarget="context-menu-popover"
                class="secondary outline"
                aria-label="메뉴" title="메뉴">
            ⚙️
        </button>
    </li>
</th:block>

<section class="board-page">
    <header>
        <hgroup>
            <h1>게시판</h1>
            <p class="board-subtitle">전체 게시글을 한곳에서 탐색하고 원하는 글을 바로 찾아보세요.</p>
        </hgroup>
    </header>

    <section class="board-content" th:unless="${#lists.isEmpty(boards.content)}">
        <table class="striped">
            <thead>
            <tr>
                <th scope="col">번호</th>
                <th scope="col">제목</th>
                <th scope="col">작성자</th>
                <th scope="col">작성일</th>
                <th scope="col">조회</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="board, iterStat : ${boards.content}">
                <td th:text="${boards.totalElements - (boards.number * boards.size) - iterStat.index}">1</td>
                <td>
                    <a th:href="@{/boards/{id}(id=${board.id})}"
                       th:text="${board.title}"
                       th:title="${board.title}">
                        게시글 제목
                    </a>
                </td>
                <td th:text="${board.authorName}">작성자</td>
                <td>
                    <time th:datetime="${board.createdAt}"
                          th:text="${#temporals.format(board.createdAt, 'MM-dd HH:mm')}">01-15 14:30
                    </time>
                </td>
                <td th:text="${board.viewCount}">123</td>
            </tr>
            </tbody>
        </table>

        <nav aria-label="페이지네이션">
            <!-- 페이지 그룹 계산 (10개 단위) -->
            <th:block th:with="currentGroup=${boards.number / 10},
                               startPage=${currentGroup * 10},
                               endPage=${T(java.lang.Math).min(startPage + 9, T(java.lang.Math).max(0, boards.totalPages - 1))},
                               displayTotalPages=${T(java.lang.Math).max(1, boards.totalPages)}">

                <!-- 이전 페이지 버튼 (항상 표시) -->
                <a th:href="@{/boards(page=${boards.number - 1}, search=${search})}"
                   th:class="${(boards.first or displayTotalPages <= 1) ? 'outline secondary' : 'outline'}"
                   th:aria-disabled="${boards.first or displayTotalPages <= 1}"
                   th:style="${(boards.first or displayTotalPages <= 1) ? 'pointer-events: none; opacity: 0.5;' : ''}"
                   role="button"
                   aria-label="이전 페이지">
                    ← 이전
                </a>

                <!-- 페이지 번호들 (10개 단위 그룹) -->
                <div style="text-align: center; display: inline-block;">
                    <!-- 데이터가 없을 때도 최소 1페이지 표시 -->
                    <th:block th:if="${displayTotalPages == 1 and boards.totalPages == 0}">
                        <a class="contrast"
                           role="button"
                           style="display: inline-block; margin: 0 0.25rem; pointer-events: none;">
                            1
                        </a>
                    </th:block>

                    <!-- 실제 페이지들 표시 -->
                    <th:block th:if="${boards.totalPages > 0}">
                        <a th:each="pageNum : ${#numbers.sequence(startPage, endPage)}"
                           th:href="@{/boards(page=${pageNum}, search=${search})}"
                           th:aria-current="${pageNum == boards.number ? 'page' : null}"
                           th:aria-label="|${pageNum + 1}페이지|"
                           th:class="${pageNum == boards.number ? 'contrast' : 'outline secondary'}"
                           th:text="${pageNum + 1}"
                           role="button"
                           style="display: inline-block; margin: 0 0.25rem;">
                            1
                        </a>
                    </th:block>
                </div>

                <!-- 다음 페이지 버튼 (항상 표시) -->
                <a th:href="@{/boards(page=${boards.number + 1}, search=${search})}"
                   th:class="${(boards.last or displayTotalPages <= 1) ? 'outline secondary' : 'outline'}"
                   th:aria-disabled="${boards.last or displayTotalPages <= 1}"
                   th:style="${(boards.last or displayTotalPages <= 1) ? 'pointer-events: none; opacity: 0.5;' : ''}"
                   role="button"
                   aria-label="다음 페이지">
                    다음 →
                </a>
            </th:block>
        </nav>

    </section>

    <!-- 컨텍스트 메뉴 Popover -->
    <aside class="pico-background-zinc-500" id="context-menu-popover" popover="auto">
        <nav>
            <ul>
                <li>
                    <button
                            command="show-modal" commandfor="search-dialog">
                        🔍 검색
                    </button>
                </li>
                <li>
                    <a sec:authorize="isAuthenticated()" href="/boards/write" role="button">
                        ✍️ 새 글 작성
                    </a>

                </li>
            </ul>
        </nav>
    </aside>

    <!-- 검색 다이얼로그 -->
    <dialog id="search-dialog">
        <article>
            <header>
                <button aria-label="검색 닫기" command="close" commandfor="search-dialog" rel="prev"></button>
                <h2>🔍 게시글 검색</h2>
            </header>
            <form class="board-search" method="get" role="search">
                <fieldset role="group">
                    <input aria-label="게시글 검색" autocomplete="off" enterkeyhint="search"
                           name="search"
                           placeholder="🔍 제목, 내용 검색" spellcheck="false" th:value="${search}"
                           type="search" />
                    <input type="submit" value="검색" />
                </fieldset>
            </form>
        </article>
    </dialog>

</section>
</body>
</html>
